let gArticleId,cards,gallery,gCloudName,perfObj={images:[]};const popup=document.querySelector("dialog.popup"),popupClose=popup.querySelector("button.close"),popupConfirm=popup.querySelector("button.confirm"),preview=document.querySelector("dialog.preview"),previewClose=preview.querySelector("button.close"),checkPerformance=()=>{if(console.log("starting checkPerformance"),void 0===performance)return console.log("Performance API NOT supported"),!1;const e=performance.getEntriesByType("resource");if(void 0===e)return console.log("Performance.getEntriesByType NOT supported"),!1;let t=!1;return e.forEach((e=>{"transferSize"in e&&(t=!0)})),t?console.log("Performance API supported for this application"):console.log("Performance API NOT supported for this application"),t};window.addEventListener("DOMContentLoaded",(e=>{console.log("DOM fully loaded and parsed"),cards=document.querySelector(".cards"),gallery=document.querySelector("#gallery .gallery"),confirm=document.querySelector("dialog.confirm"),navigator.maxTouchPoints>1?(cards.addEventListener("touchstart",cardHandler),gallery.addEventListener("touchstart",showLightbox)):(cards.addEventListener("click",cardHandler),gallery.addEventListener("click",showLightbox));const t=document.querySelector("#gallery .thumbs-minus"),l=document.querySelector("#gallery .thumbs-plus");if(t.addEventListener("click",(()=>{setGalleryWidth("down",t,l)})),l.addEventListener("click",(()=>{setGalleryWidth("up",t,l)})),new Sortable(gallery,{animation:150,ghostClass:"drag-in-progress",store:{set:async function(e){execProcess("reorderAssets",{x01:e.toArray().join(":")}).then((e=>{if(e.url){const t=document.querySelector("[data-id='"+e.articleId+"']");t.querySelector("img").src=e.url,t.querySelector(".updated-date").textContent=e.updated}}))}}}),checkPerformance()){new PerformanceObserver(perfObserver).observe({type:"resource",buffered:!0})}execProcess("setClientTZ",{x01:Intl.DateTimeFormat().resolvedOptions().timeZone}).then((()=>{console.log("Client Time Zone set for APP_PAGE_ID",apex.env.APP_PAGE_ID)}))}));const perfObserver=e=>{e.getEntries().forEach((e=>{if(e.transferSize>0&&("img"===e.initiatorType||"video"===e.initiatorType||"audio"===e.initiatorType)){const t=Math.round(1*e.duration)/1,l=e.name.split("/");let o=l.pop(),r="image";"video"===l[4]&&(r="video"),"video"===r&&"img"===e.initiatorType&&(o=o.substring(0,o.lastIndexOf("."))),perfObj.images.push({cld_cloud_name:l[3],resource_type:r,public_id:o,epoch:Math.round(Date.now()/1e3),url:e.name,transfersize:e.transferSize,duration:t,window_innerwidth:window.innerWidth,servertiming:e.serverTiming}),"video"!==e.initiatorType&&"audio"!==e.initiatorType||lightbox_audio.dispatchEvent(new CustomEvent("observed",{detail:{name:o}}))}}))},execProcess=(e,t,l)=>new Promise((o=>{const r=apex.server.process(e,t,l);r.done((function(e){e.success?o(e):popupOpen("FAILURE IN ORACLE SERVER PROCESS",e.sqlerrm)})),r.fail((function(t){popupOpen("FAILURE CALLING AJAX PROCESS "+e,t.responseText)}))})),popupOpen=(e,t)=>{const l=new DOMParser;popup.querySelector("h2").textContent=e,popup.querySelector("p").textContent=l.parseFromString("<!doctype html><body>"+t,"text/html").body.textContent,popupConfirm.style.display="none",popup.showModal()};popupClose.addEventListener("click",(()=>{popup.close()}));const saveData=async e=>{await execProcess("updateContent",{x01:gArticleId,x02:document.querySelector(".ck-word-count__words").textContent,x03:document.querySelector(".ck-word-count__characters").textContent,p_clob_01:e})},getCldSignature=async(e,t)=>{execProcess("getCldSignature",{p_clob_01:JSON.stringify(t)}).then((t=>{e(t.signature)}))},widget=cloudinary.createUploadWidget({uploadSignature:getCldSignature,sources:["local","url","camera","image_search","google_drive","facebook","dropbox","instagram","unsplash","shutterstock"],defaultSource:"local",googleApiKey:"AIzaSyCUob7BOkIEqwI6ZeBgaTUd8mb_-r5kW0Y",dropboxAppKey:"7i2pqj2wc3p47by",use_filename:!0,preBatch:(e,t)=>{let l=0;for(i=0;i<t.files.length;i++)t.files[i].name.length>248&&l++;l>0?(alert("Files names selected for upload must be no greater than 248 characters in length"),e({cancel:!0})):e({})}},((e,t)=>{if(e&&alertBoxOpen("FAILURE IN CLOUDINARY UPLOAD",e.message),t.info.files&&"queues-end"===t.event){let e={images:[]};t.info.files.forEach((t=>{t.uploadInfo&&e.images.push({public_id:t.uploadInfo.public_id,bytes:t.uploadInfo.bytes,resource_type:t.uploadInfo.resource_type,width:t.uploadInfo.width,height:t.uploadInfo.height,format:t.uploadInfo.format,cld_cloud_name:gCloudName,article_id:t.uploadInfo.tags[0]})})),execProcess("uploadMetadata",{p_clob_01:JSON.stringify(e)}).then((e=>{let t=document.querySelector("[data-id='"+e.articleId+"']"),l=t.querySelector("button.no-media.upload-media");if(l){const t=document.createElement("img");t.src=e.imgurl,l.replaceWith(t)}t.querySelector(".show-gallery").textContent="1/"+e.nbAssets,t.querySelector(".show-gallery").disabled=!1,t.querySelector(".updated-date").textContent=e.updated}))}}));"#_=_"===window.location.hash&&(history.replaceState?history.replaceState(null,null,window.location.href.split("#")[0]):window.location.hash="");const makeSuccess=e=>{e.nextElementSibling.classList.add("fa","fa-check"),e.nextElementSibling.textContent="Updated successfully"},add_card=document.querySelector(".add-card");add_card&&add_card.addEventListener("click",(e=>{if("0"===document.querySelector(".cards").children[1].dataset.id)popupOpen("Forgive the mild reproof...","You already added a new card - add content to that one before adding another");else{let e=document.querySelector(".card:first-child"),t=e.cloneNode(!0);e.style.display="grid",e.insertAdjacentElement("beforebegin",t),e.dataset.id="0",e.querySelector(".fa-id-card").textContent="0"}}));const copy_card=e=>{execProcess("copyArticle",{x01:e}).then((t=>{const l=document.querySelector("[data-id='"+e+"']"),o=l.cloneNode(!0);o.dataset.id=t.articleId,o.querySelector(".fa-id-card").textContent=t.articleId,o.querySelector(".updated-date").textContent=t.updated,l.insertAdjacentElement("afterend",o),o.focus()}))},upload_media=e=>{execProcess("getCldDetails",{x01:e}).then((t=>{if(widget.open(),widget.update({tags:[t.articleId],cloudName:t.cloudname,api_key:t.apikey}),gCloudName=t.cloudname,"0"===e){let e=document.querySelector(".cards").children[1];e.dataset.id=t.articleId,e.querySelector(".fa-id-card").textContent=t.articleId}}))},edit_text=(e,t)=>{"0"===e?execProcess("insertArticle").then((e=>{document.querySelector(".cards").children[1].dataset.id=e.articleId,gArticleId=e.articleId,apex.item("P2_RICH_TEXT_EDITOR").setValue(""),apex.theme.openRegion("editor")})):(gArticleId=e,execProcess("getContent",{x01:gArticleId},{loadingIndicator:t}).then((t=>{apex.item("P2_RICH_TEXT_EDITOR").setValue(t.content),apex.theme.openRegion("editor");const l=document.querySelector("[data-id='"+e+"'] .title");document.querySelector("#ui-id-1").textContent=l?l.textContent:"Edit Text"})))},preview_article=(e,t)=>{execProcess("getContentHTML",{x01:e},{loadingIndicator:t}).then((e=>{preview.querySelector(".content").innerHTML=e.content,preview.showModal()}))};previewClose.addEventListener("click",(()=>{preview.close()}));const save_and_exit=()=>{execProcess("saveArticle",{x01:gArticleId}).then((e=>{const t=document.querySelector("[data-id='"+gArticleId+"']"),l=t.querySelector("br"),o=t.querySelector("button.no-media.edit-text"),r=t.querySelector("h4"),i=t.querySelector("p");if(e.title){const t=document.createElement("span");if(t.textContent=e.words,r)r.textContent=e.title,i.textContent=e.excerpt,i.append(t);else{const r=document.createElement("h4"),i=document.createElement("p");r.classList.add("title","edit-text"),r.textContent=e.title,l.replaceWith(r),i.classList.add("excerpt"),i.textContent=e.excerpt,i.append(t),o.replaceWith(i)}}else if(r){const e=document.createElement("br"),t=document.createElement("button");r.replaceWith(e),t.textContent="CREATE TEXT",t.classList.add("edit-text","no-media"),i.replaceWith(t)}t.querySelector(".updated-date").textContent=e.updated,apex.theme.closeRegion("editor")}))},show_gallery=e=>{execProcess("getThumbnails",{x01:e}).then((t=>{gallery.replaceChildren(),gallery.insertAdjacentHTML("afterbegin",t.content),apex.theme.openRegion("gallery"),gArticleId=e;const l=document.querySelector("[data-id='"+e+"'] .title");document.querySelector("#ui-id-2").textContent=l?l.textContent:"Gallery",1===gallery.childElementCount&&gallery.querySelector("img").click()}))},remove_card=e=>{console.log("remove_card",e);let t=document.querySelector("[data-id='"+e+"']");console.log("li",t),t.replaceChildren(),t.remove()};popupConfirm.addEventListener("click",(e=>{const t=e.target.dataset.id,l=e.target.dataset.process;execProcess(l,{x01:t},{loadingIndicator:e.target}).then((()=>{"deleteArticle"===l&&(remove_card(t),e.target.dataset.id=""),popup.close()}))}));const delete_article=e=>{if(console.log("articleId",e),"0"===e)return void remove_card(e);let t=document.querySelector("[data-id='"+e+"']").querySelector(".title");popup.querySelector("h2").textContent=t?t.textContent:"<NO TITLE>",popup.querySelector("p").textContent="Are you sure you want to delete this card?",popupConfirm.style.display="block",popupConfirm.dataset.id=e,popupConfirm.dataset.process="deleteArticle",popup.showModal()},publish_article=(e,t)=>{execProcess("publishArticle",{x01:e,x02:"Y"}).then((()=>{t.classList.remove("publish"),t.classList.add("unpublish"),t.textContent="Unpublish"}))},unpublish_article=(e,t)=>{execProcess("publishArticle",{x01:e,x02:"N"}).then((()=>{t.classList.remove("unpublish"),t.classList.add("publish"),t.textContent="Publish"}))},cardHandler=e=>{const t=e.srcElement.closest(".card");if(!t)return;const l=t.dataset.id;e.target.matches(".delete")?delete_article(l):e.target.matches(".upload-media")?upload_media(l):e.target.matches(".edit-text")?edit_text(l,e.srcElement):e.target.matches(".show-gallery")?show_gallery(l):e.target.matches(".copy-card")?copy_card(l):e.target.matches(".publish")?publish_article(l,e.srcElement):e.target.matches(".unpublish")?unpublish_article(l,e.srcElement):e.target.matches(".preview")&&preview_article(l,e.srcElement)},galleryWidth=Number(getComputedStyle(document.documentElement).getPropertyValue("--gallery-width").match(/(\d+)/)[1]),min_gallery_width=.5*galleryWidth,max_gallery_width=1.5*galleryWidth,blur=getComputedStyle(document.documentElement).getPropertyValue("--blur");let selectedElement,lastTag,lightbox_touchstartX=0,lightbox_touchendX=0;timeout=!1;const showLightbox=e=>{"IMG"!==e.srcElement.tagName||e.srcElement.parentElement.classList.contains("deleted")||(selectedElement=e.srcElement,apex.theme.openRegion("lightbox"),execProcess("uploadPerformance",{x01:gArticleId,p_clob_01:JSON.stringify(perfObj)}).then((()=>{perfObj.images.length=0,lightbox_next.focus(),replaceImg(),lightbox_img.requestFullscreen||(lightbox_fullscreen.disabled=!0)})))},setGalleryWidth=(e,t,l)=>{const o=getComputedStyle(document.documentElement).getPropertyValue("--gallery-width");let r=Number(o.match(/(\d+)/)[1]);"up"===e?r++:r--,document.documentElement.style.setProperty("--gallery-width",r+"rem"),t.disabled=r===min_gallery_width,l.disabled=r===max_gallery_width},list_performance=document.querySelector(".list-performance"),gallery_container=document.querySelector(".gallery-container");list_performance.addEventListener("click",(()=>{execProcess("getPerformance",{x01:gArticleId}).then((e=>{gallery_container.replaceChildren(),gallery_container.insertAdjacentHTML("afterbegin",e.content)}))}));const lightbox=document.querySelector("#lightbox .lightbox"),lightbox_nav=lightbox.querySelector("nav"),lightbox_form=lightbox.querySelector(".form"),lightbox_figure=lightbox.querySelector("figure"),lightbox_message=lightbox.querySelector("figure + span"),lightbox_img=lightbox.querySelector("img"),lightbox_video=lightbox.querySelector("video"),lightbox_audio=lightbox.querySelector("audio"),lightbox_next=lightbox.querySelector(".lightbox-nextbtn"),lightbox_prev=lightbox.querySelector(".lightbox-prevbtn"),lightbox_fullscreen=lightbox.querySelector(".lightbox-fullscreen"),lightbox_update=lightbox.querySelector(".lightbox-updatebtn"),lightbox_delete=lightbox.querySelector(".lightbox-deletebtn"),lightbox_confirm_delete=lightbox.querySelector(".confirm-delete"),lightbox_confirm_ok=lightbox.querySelector(".confirm-ok"),lightbox_confirm_nok=lightbox.querySelector(".confirm-nok"),lightbox_deleted_ok=lightbox.querySelector(".deleted-ok"),lightbox_alt_text=lightbox.querySelector("#alt-text"),lightbox_description=lightbox.querySelector("#description"),lightbox_copyurl=lightbox.querySelectorAll(".lightbox-copyurlbtn"),lightbox_filename=lightbox.querySelector(".lightbox-filename"),lightbox_uploaded=lightbox.querySelector(".lightbox-uploaded"),lightbox_performance=lightbox.querySelector(".lightbox-performance"),counter=()=>{let e=selectedElement.parentElement,t=0;for(;null!=e;)e=e.previousElementSibling,null!=e&&e.classList.contains("deleted")&&t--,t++;let l=gallery.querySelectorAll(".deleted").length;return l=gallery.childElementCount-l,t+"/"+l},formatBytes=(e,t=0)=>{if(0==e)return"0B";var l=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,l)).toFixed(t))+["B","kB","mB","gB","TB","PB","EB","ZB","YB"][l]},getURL=async e=>{const t=e.dataset.dimensions.split(":").map((e=>e.substring(e,e.indexOf("x"))));let l=e.src;const o=document.fullscreenElement?window.innerWidth:lightbox_figure.clientWidth,r=t.reduce(((e,t)=>Math.abs(t-o)<Math.abs(e-o)?t:e));l=r===t[t.length-1]?l.replace(/,w_\d+/,""):l.replace(/,w_\d+/,",w_"+r),l!==e.src&&await new Promise((e=>{lightbox_img.onload=e,lightbox_img.src=l}))},getData=e=>{const t=e.dataset.dimensions.split(":"),l=t.map((e=>e.substring(e,e.indexOf("x"))));let o=e.src.substring(e.src.lastIndexOf("/")+1),r=o.lastIndexOf("_"),i=".";r>100&&(r=100,i="..."),lightbox_figure.classList.remove("deleted"),lightbox_filename.textContent=o.substring(0,r)+i+e.dataset.format,lightbox_uploaded.textContent=e.dataset.uploaded+", "+formatBytes(e.dataset.uploadedSize),document.querySelector("#ui-id-3").textContent=counter(),lightbox_alt_text.value=e.alt,charCount(lightbox_alt_text),lightbox_alt_text.nextElementSibling.classList.remove("fa","fa-check"),lightbox_description.value=e.dataset.description,charCount(lightbox_description),lightbox_description.nextElementSibling.classList.remove("fa","fa-check"),lightbox.querySelectorAll("button").forEach((e=>{e.disabled=!1})),lightbox_copyurl.forEach(((o,r)=>{o.textContent=t[r],o.dataset.text=t[r],o.classList.contains("success")&&o.classList.remove("success"),r===l.length-1?o.dataset.url=e.src.replace(/,w_\d+/,""):o.dataset.url=e.src.replace(/,w_\d+/,",w_"+l[r])})),lightbox_confirm_delete&&(lightbox_confirm_delete.style.visibility="hidden",lightbox_deleted_ok.style.visibility="hidden")},replaceImg=async()=>{const e=selectedElement;switch(getData(e),e.src.includes("/fl_waveform/")?tagName="audio":e.src.includes("/video/upload/")?tagName="video":tagName="img",tagName){case"img":lightbox_img.src=e.src,document.fullscreenElement&&getURL(e),lastTag!==tagName&&(lightbox_img.style.display="block",lightbox_video.style.display="none",lightbox_audio.style.display="none",lightbox_fullscreen.style.display="block");break;case"video":lightbox_video.src=e.src.replace(/,w_\d+/,"").replace(/.jpg/,""),lastTag!==tagName&&(lightbox_video.style.display="block",lightbox_audio.style.display="none",lightbox_img.style.display="none",lightbox_video.controls=!0,lightbox_fullscreen.style.display="none");break;case"audio":lightbox_img.src=e.src,lightbox_audio.src=e.src.replace(/,w_\d+\/fl_waveform/,"").replace(/.png/,""),lightbox_audio.style.display="block",lightbox_img.style.display="block",lightbox_video.style.display="none",lightbox_audio.controls=!0,lightbox_fullscreen.style.display="none"}lastTag=tagName},uploadPerformance=()=>{execProcess("uploadPerformance",{x01:gArticleId,x02:selectedElement.parentElement.dataset.id,p_clob_01:JSON.stringify(perfObj)}).then((e=>{perfObj.images.length=0,lightbox_performance.replaceChildren(),lightbox_performance.insertAdjacentHTML("afterbegin",e.content)}))};lightbox_video.addEventListener("observed",(e=>{uploadPerformance()})),lightbox_audio.addEventListener("observed",(e=>{uploadPerformance()})),lightbox_next.addEventListener("click",(e=>{let t=!0;for(;t;)selectedElement=selectedElement.parentElement.nextElementSibling?selectedElement.parentElement.nextElementSibling.firstElementChild:selectedElement.parentElement.parentElement.firstElementChild.firstElementChild,selectedElement.parentElement.classList.contains("deleted")||(t=!1);replaceImg()})),lightbox_prev.addEventListener("click",(e=>{let t=!0;for(;t;)selectedElement=selectedElement.parentElement.previousElementSibling?selectedElement.parentElement.previousElementSibling.firstElementChild:selectedElement.parentElement.parentElement.lastElementChild.firstElementChild,selectedElement.parentElement.classList.contains("deleted")||(t=!1);replaceImg()})),enableKeydown=e=>{const t=e.key;"Escape"===t?lightbox_close.click():"ArrowLeft"===t?lightbox_prev.click():"ArrowRight"===t&&lightbox_next.click()},lightbox_fullscreen.addEventListener("click",(e=>{document.fullscreenElement||lightbox_img.requestFullscreen&&lightbox_img.requestFullscreen().then((()=>{getURL(selectedElement),window.addEventListener("keydown",enableKeydown)})).catch((e=>{alert(`Error attempting to enable fullscreen mode: ${e.message} (${e.name})`)}))})),lightbox_img.addEventListener("fullscreenchange",(e=>{document.fullscreenElement||(window.removeEventListener("keydown",enableKeydown),lightbox_fullscreen.focus(),uploadPerformance())})),lightbox_copyurl.forEach((e=>e.addEventListener("click",(async e=>{if(!navigator.clipboard)return void console.error("Clipboard API not available");const t="success";let l=e.currentTarget,o=l.parentElement;for(const e of o.children)e.classList.contains(t)&&(e.classList.remove(t),e.innerHTML=e.dataset.text);l.classList.add(t);const r=l.dataset.url;try{await navigator.clipboard.writeText(r),l.innerHTML="COPIED"}catch(e){console.error("Failed to copy URL!",e)}}))));const charCount=e=>{let t=e.value.length;if(0==t)return void(e.nextElementSibling.textContent=null);let l=e.getAttribute("maxlength");e.nextElementSibling.textContent=t+"/"+l,e.nextElementSibling.style.color=t>=l?"red":"currentColor"};lightbox.querySelectorAll("textarea").forEach((e=>{e.addEventListener("input",(function(){charCount(this)}))})),lightbox_update&&lightbox_update.addEventListener("click",(e=>{execProcess("updateAsset",{x01:selectedElement.parentElement.dataset.id,x02:lightbox_alt_text.value,x03:lightbox_description.value}).then((e=>{selectedElement.alt!==lightbox_alt_text.value&&(makeSuccess(lightbox_alt_text),selectedElement.alt=lightbox_alt_text.value),selectedElement.dataset.description!==lightbox_description.value&&(makeSuccess(lightbox_description),selectedElement.dataset.description=lightbox_description.value)}))})),lightbox_delete&&lightbox_delete.addEventListener("click",(e=>{lightbox_confirm_delete.style.visibility="visible"})),lightbox_confirm_ok&&lightbox_confirm_ok.addEventListener("click",(e=>{lightbox_figure.classList.contains("deleted")||execProcess("deleteAsset",{x01:selectedElement.parentElement.dataset.id}).then((e=>{selectedElement.removeEventListener("click",showLightbox),lightbox_figure.classList.add("deleted"),selectedElement.parentElement.classList.add("deleted"),lightbox_confirm_delete.style.visibility="hidden",lightbox_deleted_ok.style.visibility="visible";let t=document.querySelector("#ui-id-3"),l=Number(t.textContent.split("/").pop())-1;t.textContent="x/"+l,lightbox_form.querySelectorAll("button").forEach((e=>{e.disabled=!0}));let o=cards.querySelector("[data-id='"+gArticleId+"']");if(0===l){lightbox_nav.querySelectorAll("button").forEach((e=>{e.disabled=!0}));let e=o.querySelector("img"),t=document.createElement("button");t.textContent="UPLOAD MEDIA",t.classList.add("no-media","upload-media"),e.replaceWith(t),o.querySelector(".show-gallery").disabled=!0,o.querySelector(".show-gallery").textContent="0/0"}else o.querySelector(".show-gallery").textContent="1/"+l}))})),lightbox_confirm_nok&&lightbox_confirm_nok.addEventListener("click",(e=>{lightbox_confirm_delete.style.visibility="hidden"})),lightbox.addEventListener("touchstart",(e=>{lightbox_touchstartX=e.changedTouches[0].screenX})),lightbox.addEventListener("touchend",(e=>{lightbox_touchendX=e.changedTouches[0].screenX,lightbox_touchendX<lightbox_touchstartX?lightbox_next.click():lightbox_prev.click()})),window.addEventListener("touchstart",(function e(){document.body.classList.add("touch"),window.removeEventListener("touchstart",e,!1)}),!1);