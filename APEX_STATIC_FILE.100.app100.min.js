let gArticleId,gBrowser,gConnectionType,perfObj={images:[]};const cards=document.querySelector(".cards"),galleryList=document.querySelector(".gallery-container ul"),popup=document.querySelector("dialog.popup"),popupClose=popup.querySelector("button.close"),popupConfirm=popup.querySelector("button.confirm"),preview=document.querySelector("dialog.preview"),previewClose=preview.querySelector("button.close");perftable=document.querySelector("dialog.perftable"),perftableClose=perftable.querySelector("button.close");const checkPerformance=()=>{if(void 0===performance)return console.log("Performance API NOT supported"),!1;const e=performance.getEntriesByType("resource");if(void 0===e)return console.log("Performance.getEntriesByType NOT supported"),!1;let t=!1;return e.forEach((e=>{"transferSize"in e&&(t=!0)})),t?console.log("Performance API supported for this application"):console.log("Performance API NOT supported for this application"),t};window.addEventListener("DOMContentLoaded",(e=>{console.log("DOM fully loaded and parsed"),console.log("APP_USER",apex.env.APP_USER);let t=bowser.getParser(window.navigator.userAgent),r=t.getBrowserName(),o=t.getBrowserVersion();gBrowser=r+","+o,console.log("gBrowser",gBrowser);const n=navigator.connection||navigator.mozConnection||navigator.webkitConnection;if(n&&(gConnectionType=n.downlink+" Mb/s -"+n.effectiveType,console.log("gConnectionType",gConnectionType)),navigator.maxTouchPoints>1?(cards.addEventListener("touchstart",cardHandler),galleryList.addEventListener("touchstart",showFullScreen)):(cards.addEventListener("click",cardHandler),galleryList.addEventListener("click",showFullScreen)),checkPerformance()){new PerformanceObserver(perfObserver).observe({type:"resource",buffered:!0})}execProcess("setClientTZ",{x01:Intl.DateTimeFormat().resolvedOptions().timeZone}).then((()=>{console.log("Client Time Zone set for APP_PAGE_ID",apex.env.APP_PAGE_ID)})),"onpagehide"in self&&addEventListener("pagehide",sendBeacon,{capture:!0}),addEventListener("visibilitychange",(()=>{console.log("visibilitychange"),"hidden"===document.visibilityState&&sendBeacon()}),{capture:!0})}));const sendBeacon=()=>{perfObj.images.length&&execProcess("uploadPerformance",{p_clob_01:JSON.stringify(perfObj)}).then((()=>{perfObj.images.length=0}))},perfObserver=e=>{e.getEntries().forEach((e=>{if(gBrowser.startsWith("Safari")&&"img"===e.initiatorType&&(console.log("decodedBodySize",e.decodedBodySize),console.log("transferSize",e.transferSize),console.log("duration",e.duration)),e.transferSize>300&&("img"===e.initiatorType||"video"===e.initiatorType||"audio"===e.initiatorType)){const t=Math.round(1*e.duration)/1,r=e.name.split("/");let o=r.pop(),n="image";"video"===r[4]&&(n="video"),"video"===n&&"img"===e.initiatorType&&(o=o.substring(0,o.lastIndexOf("."))),fetch(e.name,{method:"HEAD",headers:{Accept:"image/avif,image/webp,image/apng,image/svg+xml,image/*"}}).then((i=>{const s=i.headers.get("Content-Type");perfObj.images.push({cld_cloud_name:r[3],resource_type:n,public_id:o,epoch:Math.round(Date.now()/1e3),url:e.name,transfersize:e.transferSize,duration:t,content_type:s,window_innerwidth:window.innerWidth,browser:gBrowser,connection_type:gConnectionType,servertiming:e.serverTiming})})).catch((e=>{console.error("Error fetching image content-type:",e)}))}}))},execProcess=(e,t,r)=>new Promise((o=>{const n=apex.server.process(e,t,r);n.done((function(e){e.success?o(e):popupOpen("FAILURE IN ORACLE SERVER PROCESS",e.sqlerrm)})),n.fail((function(t){popupOpen("FAILURE CALLING AJAX PROCESS "+e,t.responseText)}))})),popupOpen=(e,t)=>{const r=new DOMParser;popup.querySelector("h2").textContent=e,popup.querySelector("p").textContent=r.parseFromString("<!doctype html><body>"+t,"text/html").body.textContent,popupConfirm.style.display="none",popup.showModal()};popupClose.addEventListener("click",(()=>{popup.close()}));const preview_article=(e,t)=>{execProcess("getContentHTML",{x01:e},{loadingIndicator:t}).then((e=>{const t=preview.querySelector(".content");t.innerHTML=e.content;t.firstElementChild.insertAdjacentHTML("afterend",e.details),preview.showModal()}))};previewClose.addEventListener("click",(()=>{preview.close()}));const show_gallery=e=>{execProcess("getThumbnails",{x01:e}).then((t=>{apex.theme.openRegion("gallery"),galleryList.replaceChildren(),galleryList.insertAdjacentHTML("afterbegin",t.content),gArticleId=e;const r=document.querySelector("[data-id='"+e+"'] .title");document.querySelector("#ui-id-"+apex.env.APP_PAGE_ID).textContent=r?r.textContent:"Gallery"}))},cardHandler=e=>{const t=e.srcElement.closest(".card");if(!t)return;const r=t.dataset.id;e.target.matches(".show-gallery")?show_gallery(r):e.target.matches(".preview")&&preview_article(r,e.srcElement)},showFullScreen=e=>{const t=e.srcElement;document.fullscreenElement||t.requestFullscreen&&t.requestFullscreen().then((()=>{console.log("requestFullscreen")})).catch((e=>{popup(`Error attempting to enable fullscreen mode",${e.message} (${e.name})`)}))},galleryWidth=Number(getComputedStyle(document.documentElement).getPropertyValue("--gallery-width").match(/(\d+)/)[1]),min_gallery_width=.5*galleryWidth,max_gallery_width=1.5*galleryWidth,thumbs_minus=document.querySelector("#gallery .thumbs-minus"),thumbs_plus=document.querySelector("#gallery .thumbs-plus");thumbs_minus.addEventListener("click",(()=>{setGalleryWidth("down",thumbs_minus,thumbs_plus)})),thumbs_plus.addEventListener("click",(()=>{setGalleryWidth("up",thumbs_minus,thumbs_plus)}));const setGalleryWidth=(e,t,r)=>{const o=getComputedStyle(document.documentElement).getPropertyValue("--gallery-width");let n=Number(o.match(/(\d+)/)[1]);"up"===e?n++:n--,document.documentElement.style.setProperty("--gallery-width",n+"rem"),t.disabled=n===min_gallery_width,r.disabled=n===max_gallery_width},list_performance=document.querySelector(".list-performance");list_performance.addEventListener("click",(()=>{execProcess("uploadPerformance",{p_clob_01:JSON.stringify(perfObj)}).then((()=>{perfObj.images.length=0,execProcess("getPerformance",{x01:gArticleId}).then((e=>{perftable.querySelector(".content").innerHTML=e.content,perftable.showModal()}))}))})),perftable.addEventListener("click",(()=>{perftable.close()})),window.addEventListener("touchstart",(function e(){document.body.classList.add("touch"),window.removeEventListener("touchstart",e,!1)}),!1);